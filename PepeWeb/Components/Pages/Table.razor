@page "/table/{tableId:int}"

@using Microsoft.AspNetCore.Authorization
@using PepeWeb.Data.DTO;
@using PepeWeb.Data.VirtualModels;
@using System.Diagnostics

@rendermode InteractiveServer

@inject PepeWeb.Services.TableService tableService
@inject NavigationManager navigationManager

@attribute [StreamRendering]
@attribute [Authorize]

<PageTitle>Auth</PageTitle>

<AuthorizeView>
    <Authorized>
       
        @if (_table != null)
        {
            <h1>@_table.Name</h1>

            <button class="btn btn-success" type="button" @onclick="AddRecord">+ Add record</button>
            <button class="btn btn-outline-warning" type="button" @onclick="EditTable">Edit table</button>

            <table class="table">
                <tr>
                    @foreach (FieldDTO col in _table.Columns)
                    {
                        <th>@col.Name</th>
                    }
                </tr>
                @foreach (TableRow row in _table.Rows)
                {
                    <tr>
                        @foreach (string val in row.Values)
                        {
                            <td>@val</td>
                        }
                    </tr>
                }
            </table>
        }
        else
        {
            <p>Table didn't load.</p>
        }

    </Authorized>
    <NotAuthorized>
        You are not authorized to view this content. Please log in.
    </NotAuthorized>
</AuthorizeView>

@code {

    [Parameter]
    public int tableId { get; set; }

    private TableConstructDTO? _table;

    protected override async Task OnParametersSetAsync()
    {
        // Get user's table
        TableConstructDTO userTable = await tableService.GetUserTableData(tableId);
        _table = userTable;
    }

    private void AddRecord()
    {
        // TODO
    }

    private void EditTable()
    {
        try
        {
            navigationManager.NavigateTo($"/edit/{tableId}");
        }
        catch (Exception e)
        {
            throw new Exception(e.Message);
        }

    }

}